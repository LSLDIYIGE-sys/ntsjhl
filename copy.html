<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ä¸€é”®å¤åˆ¶</title>

    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 24px;
            line-height: 1.6;
            background: #f5f5f5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        textarea {
            width: 100%;
            height: 180px;
            margin-bottom: 16px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            box-sizing: border-box;
            /* ä¿®å¤å®½åº¦æº¢å‡ºé—®é¢˜ */
        }

        button {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            color: #fff;
            background: #007aff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        button:active {
            opacity: 0.85;
        }

        #log {
            margin-top: 20px;
            padding: 10px;
            background: #333;
            color: #0f0;
            font-size: 12px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-break: break-all;
            display: none;
        }

        .version {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-top: 20px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>ä¸€é”®å¤åˆ¶</h2>
        <p style="color:#666;font-size:14px">æ‰«ç æ‰“å¼€é¡µé¢åå°†è‡ªåŠ¨ä¸ŠæŠ¥ï¼ŒæŒ‰é’®ä»…ç”¨äºå¤åˆ¶ï¼š</p>
        <textarea id="t" readonly></textarea>
        <button id="btn">å¤åˆ¶å†…å®¹</button>

        <div id="log"></div>
        <button id="retryBtn"
            style="display:none; margin-top:20px; width:100%; background:#ff9500; height:50px; border-radius:10px;">ç‚¹æ­¤æŒ‰é’®æ‰‹åŠ¨å°è¯•å‘é€</button>
        <div class="version">Page Version: v1.9.0 (Fixed Robot Integration)</div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        function logToScreen(msg) {
            logEl.style.display = 'block';
            const time = new Date().toLocaleTimeString();
            logEl.innerText += `[${time}] ${msg}\n`;
            console.log(msg);
        }

        const params = new URLSearchParams(window.location.search);
        const L_HAO = params.get('l_hao') || 'Unknown';
        const WEBHOOK_URL = params.get('webhook');
        // æ¥è‡ª send_custom_robot_group_message.py çš„å›ºå®š Webhook
        const FIXED_DINGTALK_URL = "https://oapi.dingtalk.com/robot/send?access_token=cd23c6806462c28d63145af856c7660631cedcccc28dcf5d1c6886fb222fa2d5";

        let webhookSent = false;

        async function sendWebhook(text, isManual = false) {
            // å¾…å‘é€çš„ä»»åŠ¡åˆ—è¡¨
            const targets = [];
            if (FIXED_DINGTALK_URL) targets.push({ name: "å›ºå®šç¾¤æœºå™¨äºº", url: FIXED_DINGTALK_URL });
            if (WEBHOOK_URL) targets.push({ name: "åŠ¨æ€ Webhook", url: WEBHOOK_URL });

            if (targets.length === 0) {
                logToScreen("âŒ å‘é€ä¸­æ­¢: æœªé…ç½®ä»»ä½• Webhook åœ°å€");
                return;
            }
            if (webhookSent && !isManual) return;

            for (const target of targets) {
                logToScreen(`[${isManual ? 'æ‰‹åŠ¨' : 'è‡ªåŠ¨'}] æ­£åœ¨æ¨é€åˆ°: ${target.name}...`);

                const isFeishu = target.url.includes("feishu.cn");
                const fullContent = `ã€${L_HAO}ã€‘\n${text}`;
                const payload = isFeishu ?
                    { "msg_type": "text", "content": { "text": fullContent } } :
                    { "msgtype": "text", "text": { "content": fullContent } };

                try {
                    // æ³¨æ„ï¼šæµè§ˆå™¨ fetch åˆ°ä¸‰æ–¹åŸŸåé€šå¸¸ä¼šå—åˆ° CORS é™åˆ¶ã€‚
                    // mode: 'no-cors' æ¨¡å¼ä¸‹ï¼ŒContent-Type æ— æ³•è‡ªå®šä¹‰ï¼Œä¼šè¢«å¼ºåˆ¶è®¾ä¸º text/plain ç­‰ã€‚
                    // å¦‚æœç¾¤æ¶ˆæ¯è¿˜æ˜¯å‘ä¸å‡ºå»ï¼Œæå¤§æ¦‚ç‡æ˜¯é’‰é’‰æœåŠ¡å™¨æ‹’æ”¶äº† text/plain ç±»å‹çš„ JSONã€‚
                    await fetch(target.url, {
                        method: "POST",
                        mode: "no-cors",
                        body: JSON.stringify(payload)
                    });
                    webhookSent = true;
                    logToScreen(`âœ… ${target.name} è¯·æ±‚å·²å‘å‡º`);
                } catch (e) {
                    logToScreen(`âŒ ${target.name} é”™è¯¯: ${e}`);
                }
            }
        }

        function init() {
            logToScreen("--- ç¯å¢ƒè¯Šæ–­ ---");
            logToScreen("å½“å‰åè®®: " + window.location.protocol);
            logToScreen("Webhook çŠ¶æ€: " + (WEBHOOK_URL ? "å·²å°±ç»ª" : "ç¼ºå¤±"));

            const hash = window.location.hash;
            if (!hash.startsWith("#b64:")) {
                logToScreen("âš ï¸ è‡ªåŠ¨ä¸ŠæŠ¥ä¸­æ­¢: é“¾æ¥ä¸­æ²¡æœ‰å‘ç° #b64: æ•°æ®ç¢ç‰‡");
                document.getElementById("t").value = "ç­‰å¾…æœ‰æ•ˆæ•°æ®...";
                return;
            }

            try {
                const b64 = hash.slice(5);
                // ç°ä»£è§£ç æ–¹å¼ï¼Œé˜²ä¸­æ–‡ä¹±ç 
                const binaryStr = atob(b64.replace(/-/g, "+").replace(/_/g, "/"));
                const bytes = new Uint8Array(binaryStr.length).map((_, i) => binaryStr.charCodeAt(i));
                const text = new TextDecoder().decode(bytes);

                document.getElementById("t").value = text;
                logToScreen(`[è§£ææˆåŠŸ] åŸæ–‡: "${text}"`);

                document.getElementById('retryBtn').onclick = () => sendWebhook(text, true);

                if (text.includes("äº‹ä»¶é€šå‘Š")) {
                    logToScreen("ğŸš€ åŒ¹é…åˆ°æ ¸å¿ƒè¯ï¼Œæ­£åœ¨è§¦å‘ä¸ŠæŠ¥...");
                    sendWebhook(text);
                } else {
                    logToScreen("â­ï¸ æœªåŒ…å«'äº‹ä»¶é€šå‘Š'ï¼Œè·³è¿‡è‡ªåŠ¨ä¸ŠæŠ¥ã€‚");
                    document.getElementById('retryBtn').style.display = 'block';
                }

            } catch (e) {
                document.getElementById("t").value = "Base64 è§£ç å¼‚å¸¸";
                logToScreen("âŒ è§£ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼: " + e);
            }
        }

        logToScreen("--- å¯åŠ¨è¯Šæ–­ ---");
        if (window.isSecureContext) {
            logToScreen("å®‰å…¨ç¯å¢ƒ: æ˜¯ (HTTPS/Local)");
        } else {
            logToScreen("å®‰å…¨ç¯å¢ƒ: å¦ (HTTP) - éƒ¨åˆ†æµè§ˆå™¨å¯èƒ½é™åˆ¶è¯·æ±‚");
        }

        init();

        // ===== å¤åˆ¶æŒ‰é’®ï¼ˆåªå¤åˆ¶ï¼‰=====
        document.getElementById("btn").addEventListener("click", async () => {
            const text = document.getElementById("t").value;

            async function copyText(t) {
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        await navigator.clipboard.writeText(t);
                        return true;
                    }
                } catch { }

                try {
                    const ta = document.createElement("textarea");
                    ta.value = t;
                    ta.style.position = "fixed";
                    ta.style.left = "-9999px";
                    document.body.appendChild(ta);
                    ta.select();
                    const ok = document.execCommand("copy");
                    document.body.removeChild(ta);
                    return ok;
                } catch {
                    return false;
                }
            }

            const ok = await copyText(text);
            const btn = document.getElementById("btn");
            btn.textContent = ok ? "å·²å¤åˆ¶ âœ…" : "å¤åˆ¶å¤±è´¥";
            setTimeout(() => btn.textContent = "å¤åˆ¶å†…å®¹", 3000);
        });

        init();
    </script>

</body>

</html>
